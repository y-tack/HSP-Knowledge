name: PR Auto Review and Merge

on:
  # å¤‰æ›´ç‚¹1: pull_request ã§ã¯ãªã pull_request_target ã‚’ä½¿ç”¨
  # ã“ã‚Œã«ã‚ˆã‚Š Fork ã‹ã‚‰ã® PR ã§ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™ãŒä»˜ä¸Žã•ã‚Œã¾ã™
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**/*.md'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ---------------------------------------------------
  # Job 1: å½¢å¼ãƒã‚§ãƒƒã‚¯ & çµæžœã‚³ãƒ¡ãƒ³ãƒˆ (PRä½œæˆãƒ»æ›´æ–°æ™‚ã«å®Ÿè¡Œ)
  # ---------------------------------------------------
  validate-format:
    name: Validate Format
    runs-on: ubuntu-latest
    # pull_request_target ãªã®ã§ã€event_name ã§ã®åˆ†å²æ¡ä»¶ã‚’ä¿®æ­£
    if: github.event_name == 'pull_request_target'

    steps:
      # é‡è¦: pull_request_target ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œè¦ªã®mainã€ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚
      # æŠ•ç¨¿ã•ã‚ŒãŸè¨˜äº‹ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€PRã®ã‚³ãƒŸãƒƒãƒˆã‚’æ˜Žç¤ºçš„ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }} # PRã®å…ˆç«¯ã‚’å–å¾—
          fetch-depth: 0

      # é‡è¦: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ”¹ã–ã‚“ã‚’é˜²ããŸã‚ã€æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã ã‘ã¯
      # å¿…ãšã€Œè¦ªãƒªãƒã‚¸ãƒˆãƒªã®mainã€ã‹ã‚‰å¾©å…ƒã—ã¦ä¸Šæ›¸ãã—ã¾ã™ã€‚
      - name: Restore trusted scripts
        run: |
          git fetch origin ${{ github.event.repository.default_branch }}
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check Format
        run: |
          # å·®åˆ†å–å¾—ã®æ¯”è¼ƒå…ƒã‚’èª¿æ•´
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          echo "## ðŸ“ å½¢å¼ãƒã‚§ãƒƒã‚¯çµæžœ" > report.md
          echo "" >> report.md

          has_error=false
          has_files=false

          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              has_files=true
              # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆå‰Šé™¤ã•ã‚ŒãŸå ´åˆãªã©ã®ã‚¨ãƒ©ãƒ¼å›žé¿ï¼‰
              if [ -f "$file" ]; then
                python scripts/check_pr.py "$file" > result.json

                valid=$(jq -r '.is_valid_format' result.json)
                errors=$(jq -r '.issues | join(", ")' result.json)

                if [ "$valid" == "true" ]; then
                  echo "- âœ… **$file**: å½¢å¼OK" >> report.md
                else
                  echo "- âŒ **$file**: å½¢å¼ã‚¨ãƒ©ãƒ¼" >> report.md
                  echo "  - ç†ç”±: $errors" >> report.md
                  has_error=true
                fi
              fi
            fi
          done < changed_files.txt

          if [ "$has_files" = "false" ]; then
            echo "æ¤œè¨¼å¯¾è±¡ã®è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> report.md
          elif [ "$has_error" == "true" ]; then
            echo "" >> report.md
            echo "âŒ å½¢å¼ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ãŸã‚ã€ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚" >> report.md
          else
            echo "" >> report.md
            echo "âœ… å½¢å¼ã¯æ­£å¸¸ã§ã™ã€‚Geminiã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€å•é¡Œãªã‘ã‚Œã° \`/publish\` ã§å…¬é–‹ã§ãã¾ã™ã€‚" >> report.md
          fi

          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment Result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ---------------------------------------------------
  # Job 2: å…¬é–‹ãƒ»ãƒžãƒ¼ã‚¸å‡¦ç† (/publish ã‚³ãƒžãƒ³ãƒ‰ã§å®Ÿè¡Œ)
  # ---------------------------------------------------
  publish-article:
    name: Publish Article
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/publish')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get PR Info
        id: pr
        run: echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      # 1. ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…ãŒPRä½œæˆè€…æœ¬äººã‹ç¢ºèª
      - name: Check Author
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });
            if (pr.data.user.login !== context.payload.comment.user.login) {
              core.setFailed('â›”ï¸ /publish ã‚³ãƒžãƒ³ãƒ‰ã¯PRä½œæˆè€…ã®ã¿ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚');
            }

      # 2. Geminiã®ã‚¹ãƒ‘ãƒ åˆ¤å®šã‚’ç¢ºèª
      - name: Check Gemini Verdict
        id: gemini-check
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }}
            });

            // Gemini (gemini-code-assistã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼) ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const botComments = comments.data.filter(c =>
              c.user.login.includes('gemini') && c.body.includes('[SPAM-CHECK:')
            );

            if (botComments.length === 0) {
              core.setFailed('â›”ï¸ Geminiã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ‘ãƒ åˆ¤å®šï¼‰ãŒã¾ã è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            const lastComment = botComments[botComments.length - 1];
            if (lastComment.body.includes('[SPAM-CHECK: FAIL]')) {
              core.setFailed('â›”ï¸ Geminiã«ã‚ˆã‚Šã‚¹ãƒ‘ãƒ ã¾ãŸã¯ä¸é©åˆ‡ã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒžãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚');
            } else if (lastComment.body.includes('[SPAM-CHECK: PASS]')) {
              console.log('Gemini check passed.');
            } else {
              core.setFailed('â›”ï¸ Geminiã®åˆ¤å®šã‚¿ã‚°ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
            }

      # 3. å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚å†å®Ÿè¡Œï¼‰
      - name: Final Format Check
        run: |
          # å¿…è¦ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦mainã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å¾©å…ƒ
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-branch
          git checkout pr-branch
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py
          pip install pyyaml

          # ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD > changed_files.txt
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              if [ -f "$file" ]; then
                python scripts/check_pr.py "$file" > result.json
                if [ "$(jq -r '.is_valid_format' result.json)" != "true" ]; then
                  echo "Format Error in $file"
                  exit 1
                fi
              fi
            fi
          done < changed_files.txt

      # 4. ãƒžãƒ¼ã‚¸å®Ÿè¡Œ
      - name: Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              merge_method: 'squash'
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: 'ðŸŽ‰ è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼'
            });
