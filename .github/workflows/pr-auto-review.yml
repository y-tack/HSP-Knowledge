name: PR Auto Review and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**/*.md'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-article:
    name: Validate Article Submission
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
      
      - name: Validate articles
        id: check
        run: |
          echo "[" > validation_results.json
          first=true
          has_files=false
          
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              echo "Validating: $file"
              has_files=true
              
              original_file=""
              if git show origin/${{ github.base_ref }}:"$file" > /tmp/original.md 2>/dev/null; then
                original_file="/tmp/original.md"
              fi
              
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> validation_results.json
              fi

              if [ -n "$original_file" ]; then
                python scripts/check_pr.py "$file" "$original_file" >> validation_results.json
              else
                python scripts/check_pr.py "$file" >> validation_results.json
              fi
            fi
          done < changed_files.txt
          
          echo "]" >> validation_results.json
          
          if [ "$has_files" = true ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "[]" > validation_results.json
          fi
      
      - name: Post validation result
        if: steps.check.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let results;
            try {
              results = JSON.parse(fs.readFileSync('validation_results.json', 'utf8'));
            } catch (error) {
              console.log('Could not read validation results');
              return;
            }
            
            // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®çµæœã‚’ã‚µãƒãƒªãƒ¼ï¼ˆå½¢å¼ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
            let comment = '## ğŸ“ è¨˜äº‹å½¢å¼æ¤œè¨¼çµæœ\n\n';
            let allAutoApprove = true;
            let hasFormatError = false;

            for (const res of results) {
              if (!res.is_valid_format) hasFormatError = true;
              if (!res.auto_approve) allAutoApprove = false;
            }

            if (hasFormatError) {
              comment += 'âš ï¸ **å½¢å¼ã‚¨ãƒ©ãƒ¼**: è¨˜äº‹ã®å½¢å¼ã«ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚\n\n';
            } else if (allAutoApprove) {
              comment += 'âœ… **å½¢å¼OK**: è¨˜äº‹ã®å½¢å¼ã¯é©åˆ‡ã§ã™ï¼\n\n';
              comment += 'Geminiã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡ã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€æŠ•ç¨¿è€…ã¯ `/publish` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§è‡ªå‹•ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚\n\n';
            } else {
              comment += 'âš ï¸ **è¦ç¢ºèª**: å•é¡ŒãŒã‚ã‚‹ãŸã‚è‡ªå‹•æ‰¿èªã§ãã¾ã›ã‚“ã€‚\n\n';
            }
            
            if (results.length > 0) {
              comment += '### è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ\n\n';
              results.forEach((res) => {
                 if (res.issues.length > 0) {
                   comment += `- âš ï¸ **è¦ä¿®æ­£**: ${res.issues.join(', ')}\n`;
                 } else {
                   comment += `- âœ… å•é¡Œãªã—\n`;
                 }
              });
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  auto-merge:
    name: Auto Approve and Merge
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/publish')
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR number
        id: pr
        run: |
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Fetch Gemini verdict
        id: gemini-verdict
        uses: actions/github-script@v7
        with:
          script: |
            // PRå†…ã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }}
            });

            // Gemini Code Assistï¼ˆã¾ãŸã¯é¡ä¼¼ãƒœãƒƒãƒˆï¼‰ã«ã‚ˆã‚‹ã‚¹ãƒ‘ãƒ åˆ¤å®šã‚¿ã‚°ã‚’æ¢ã™
            const geminiComments = comments.data.filter(c =>
              c.user.type === 'Bot' ||
              c.user.login.toLowerCase().includes('gemini') ||
              c.user.login.toLowerCase().includes('code-assist')
            );

            // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰åˆ¤å®šã‚¿ã‚°ã‚’æ¤œç´¢
            let latestVerdict = null;
            for (const comment of geminiComments.reverse()) {
              if (comment.body.includes('[SPAM-CHECK:')) {
                latestVerdict = comment;
                break;
              }
            }

            if (!latestVerdict) {
              core.setOutput('gemini_checked', 'false');
              core.setOutput('gemini_pass', 'false');
              console.log('Geminiã«ã‚ˆã‚‹ã‚¹ãƒ‘ãƒ åˆ¤å®šãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚');
              return;
            }

            const isPass = latestVerdict.body.includes('[SPAM-CHECK: PASS]');
            core.setOutput('gemini_checked', 'true');
            core.setOutput('gemini_pass', isPass.toString());

            if (isPass) {
              console.log('âœ… Geminiã‚¹ãƒ‘ãƒ åˆ¤å®š: PASS');
            } else {
              console.log('âŒ Geminiã‚¹ãƒ‘ãƒ åˆ¤å®š: FAIL');
            }

      - name: Check if commenter is PR author
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });
            
            const isAuthor = pr.data.user.login === context.payload.comment.user.login;
            core.setOutput('is_author', isAuthor);
            if (!isAuthor) {
              console.log('Commenter is not the PR author.');
            }
            return isAuthor;

      # PRã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—ã®ãŸã‚ï¼‰
      - name: Checkout PR branch
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-${{ steps.pr.outputs.number }}
          git checkout pr-${{ steps.pr.outputs.number }}
      
      # ã€é‡è¦ã€‘æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å–å¾—ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
      - name: Restore trusted scripts
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py
      
      - name: Set up Python
        if: steps.check-author.outputs.is_author == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          pip install pyyaml
      
      - name: Re-validate articles
        if: steps.check-author.outputs.is_author == 'true'
        id: validate
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®šï¼ˆãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ï¼‰
          git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD > changed_files.txt
          
          auto_approve_all=true
          has_files=false
          
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              echo "Re-validating: $file"
              has_files=true
              
              original_file=""
              if git show origin/${{ github.event.repository.default_branch }}:"$file" > /tmp/original.md 2>/dev/null; then
                original_file="/tmp/original.md"
              fi
              
              # ä¿¡é ¼ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
              if [ -n "$original_file" ]; then
                python scripts/check_pr.py "$file" "$original_file" > result.json
              else
                python scripts/check_pr.py "$file" > result.json
              fi
              
              # åˆ¤å®š
              is_approve=$(jq -r '.auto_approve' result.json)
              if [ "$is_approve" != "true" ]; then
                auto_approve_all=false
                echo "Validation failed for $file"
                cat result.json
              fi
            fi
          done < changed_files.txt
          
          if [ "$has_files" = false ]; then
             auto_approve_all=false
          fi

          echo "auto_approve=$auto_approve_all" >> $GITHUB_OUTPUT
      
      - name: Check merge conditions
        id: merge-check
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          # å½¢å¼ãƒã‚§ãƒƒã‚¯ã¨Geminiåˆ¤å®šã®ä¸¡æ–¹ãŒå¿…è¦
          format_ok="${{ steps.validate.outputs.auto_approve }}"
          gemini_checked="${{ steps.gemini-verdict.outputs.gemini_checked }}"
          gemini_pass="${{ steps.gemini-verdict.outputs.gemini_pass }}"

          echo "å½¢å¼ãƒã‚§ãƒƒã‚¯: $format_ok"
          echo "Geminiåˆ¤å®šæ¸ˆã¿: $gemini_checked"
          echo "Geminiåˆ¤å®šçµæœ: $gemini_pass"

          if [ "$format_ok" = "true" ] && [ "$gemini_checked" = "true" ] && [ "$gemini_pass" = "true" ]; then
            echo "can_merge=true" >> $GITHUB_OUTPUT
            echo "âœ… å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ"
          else
            echo "can_merge=false" >> $GITHUB_OUTPUT
            if [ "$format_ok" != "true" ]; then
              echo "âŒ å½¢å¼ãƒã‚§ãƒƒã‚¯ãŒä¸åˆæ ¼ã§ã™"
            fi
            if [ "$gemini_checked" != "true" ]; then
              echo "â³ Geminiã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
            elif [ "$gemini_pass" != "true" ]; then
              echo "âŒ GeminiãŒã‚¹ãƒ‘ãƒ ã¨åˆ¤å®šã—ã¾ã—ãŸ"
            fi
          fi

      - name: Comment on check failure
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.merge-check.outputs.can_merge == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const formatOk = '${{ steps.validate.outputs.auto_approve }}' === 'true';
            const geminiChecked = '${{ steps.gemini-verdict.outputs.gemini_checked }}' === 'true';
            const geminiPass = '${{ steps.gemini-verdict.outputs.gemini_pass }}' === 'true';

            let comment = '## âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸æ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n';
            comment += 'è‡ªå‹•ãƒãƒ¼ã‚¸ã«ã¯ä»¥ä¸‹ã®æ¡ä»¶ã‚’å…¨ã¦æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š\n\n';
            comment += formatOk ? '- âœ… å½¢å¼ãƒã‚§ãƒƒã‚¯\n' : '- âŒ å½¢å¼ãƒã‚§ãƒƒã‚¯\n';

            if (!geminiChecked) {
              comment += '- â³ Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡ï¼‰\n';
            } else if (geminiPass) {
              comment += '- âœ… Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼\n';
            } else {
              comment += '- âŒ Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ‘ãƒ åˆ¤å®šï¼‰\n';
            }

            comment += '\nå•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ `/publish` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: comment
            });

      - name: Approve PR
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.merge-check.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              event: 'APPROVE',
              body: 'âœ… è‡ªå‹•æ‰¿èª: å½¢å¼ãƒã‚§ãƒƒã‚¯ã¨Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¸¡æ–¹ã«åˆæ ¼ã—ã¾ã—ãŸã€‚'
            });

      - name: Merge PR
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.merge-check.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }},
                merge_method: 'squash'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: 'ğŸ‰ è¨˜äº‹ãŒè‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼'
              });
            } catch (error) {
              console.error('Merge failed:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: 'âŒ è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message
              });
            }

      - name: Comment if not author
        if: steps.check-author.outputs.is_author == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: 'âš ï¸ `/publish` ã‚³ãƒãƒ³ãƒ‰ã¯PRã®ä½œæˆè€…ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ã€‚'
            });
