name: PR Auto Review and Merge

on:
  # Â§âÊõ¥ÁÇπ1: pull_request „Åß„ÅØ„Å™„Åè pull_request_target „Çí‰ΩøÁî®
  # „Åì„Çå„Å´„Çà„Çä Fork „Åã„Çâ„ÅÆ PR „Åß„ÇÇ„Ç≥„É°„É≥„ÉàÊäïÁ®øÊ®©Èôê„Åå‰ªò‰∏é„Åï„Çå„Åæ„Åô
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**/*.md'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ---------------------------------------------------
  # Job 1: ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ & ÁµêÊûú„Ç≥„É°„É≥„Éà (PR‰ΩúÊàê„ÉªÊõ¥Êñ∞ÊôÇ„Å´ÂÆüË°å)
  # ---------------------------------------------------
  validate-format:
    name: Validate Format
    runs-on: ubuntu-latest
    # pull_request_target „Å™„ÅÆ„Åß„ÄÅevent_name „Åß„ÅÆÂàÜÂ≤êÊù°‰ª∂„Çí‰øÆÊ≠£
    if: github.event_name == 'pull_request_target'

    steps:
      # ÈáçË¶Å: pull_request_target „ÅØ„Éá„Éï„Ç©„É´„Éà„Åß„ÄåË¶™„ÅÆmain„Äç„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÄÇ
      # ÊäïÁ®ø„Åï„Çå„ÅüË®ò‰∫ã„ÇíÊ§úË®º„Åô„Çã„Åü„ÇÅ„Å´„ÄÅPR„ÅÆ„Ç≥„Éü„ÉÉ„Éà„ÇíÊòéÁ§∫ÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }} # PR„ÅÆÂÖàÁ´Ø„ÇíÂèñÂæó
          fetch-depth: 0

      # ÈáçË¶Å: „Çπ„ÇØ„É™„Éó„Éà„ÅÆÊîπ„Åñ„Çì„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅÊ§úË®º„Çπ„ÇØ„É™„Éó„Éà„Å†„Åë„ÅØ
      # ÂøÖ„Åö„ÄåË¶™„É™„Éù„Ç∏„Éà„É™„ÅÆmain„Äç„Åã„ÇâÂæ©ÂÖÉ„Åó„Å¶‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇ
      - name: Restore trusted scripts
        run: |
          git fetch origin ${{ github.event.repository.default_branch }}
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check Format
        run: |
          # „Éá„Éê„ÉÉ„Ç∞: „Ç∑„Çß„É´„ÅÆÂãï‰Ωú„ÇíÁ¢∫Ë™ç
          set -x  # „Ç≥„Éû„É≥„Éâ„Çí„Ç®„Ç≥„Éº

          # ÂøÖË¶Å„Å™„ÉÑ„Éº„É´„ÅÆÁ¢∫Ë™ç
          echo "=== Tool versions ==="
          jq --version || echo "ERROR: jq not found"
          python --version || echo "ERROR: python not found"
          echo "===================="

          # Â∑ÆÂàÜÂèñÂæó„ÅÆÊØîËºÉÂÖÉ„ÇíË™øÊï¥
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # „Éá„Éê„ÉÉ„Ç∞: Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫
          echo "=== Changed files ==="
          cat changed_files.txt
          echo "=== End of changed files ==="

          echo "## üìù ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú" > report.md
          echo "" >> report.md

          has_error=false
          has_files=false

          while IFS= read -r file; do
            # --- üõ°Ô∏è „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØËøΩÂä† ---
            # 1) „Éõ„ÉØ„Ç§„Éà„É™„Çπ„Éà: `_posts/` ÈÖç‰∏ã„ÅÆ .md ‰ª•Â§ñ„ÅÆÂ§âÊõ¥„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çå„Å∞„Ç®„É©„Éº
            if [[ "$file" != _posts/*.md ]]; then
              echo "- ‚ùå **$file**: „Ç∑„Çπ„ÉÜ„É†‰øùË≠∑„ÅÆ„Åü„ÇÅ„ÄÅ\`_posts/\` ‰ª•Â§ñ„ÅÆ„Éï„Ç°„Ç§„É´Â§âÊõ¥„ÇíÂê´„ÇÄPR„ÅØËá™ÂãïÊâøË™ç„Åß„Åç„Åæ„Åõ„Çì„ÄÇ" >> report.md
              has_error=true
              continue
            fi

            # 2) „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´„ÅÆÂ§âÊõ¥„ÅØÁ¶ÅÊ≠¢
            if [[ "$file" == "_posts/template.md" ]]; then
              echo "- ‚ùå **$file**: „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´„ÅÆÂ§âÊõ¥„ÅØÁ¶ÅÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ" >> report.md
              has_error=true
              continue
            fi
            # ------------------------------------

            has_files=true
            # „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™çÔºàÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„Å™„Å©„ÅÆ„Ç®„É©„ÉºÂõûÈÅøÔºâ
            if [ -f "$file" ]; then
              echo "=== Checking file: $file ==="
              python scripts/check_pr.py "$file" > result.json || {
                echo "ERROR: check_pr.py failed for $file"
                cat result.json || echo "result.json not created"
                exit 1
              }

              echo "=== result.json content ==="
              cat result.json
              echo "=== end result.json ==="

              valid=$(jq -r '.is_valid_format' result.json) || {
                echo "ERROR: jq failed to parse result.json"
                exit 1
              }
              errors=$(jq -r '.issues | join(", ")' result.json) || {
                echo "ERROR: jq failed to extract issues"
                exit 1
              }

              if [ "$valid" == "true" ]; then
                echo "- ‚úÖ **$file**: ÂΩ¢ÂºèOK" >> report.md
              else
                echo "- ‚ùå **$file**: ÂΩ¢Âºè„Ç®„É©„Éº" >> report.md
                echo "  - ÁêÜÁî±: $errors" >> report.md
                has_error=true
              fi
            fi
          done < changed_files.txt || true  # read „ÅÆÁµÇ‰∫Ü„Ç≥„Éº„Éâ„ÇíÁÑ°Ë¶ñ

          if [ "$has_files" = "false" ]; then
            echo "Ê§úË®ºÂØæË±°„ÅÆË®ò‰∫ã„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ" >> report.md
          elif [ "$has_error" == "true" ]; then
            echo "" >> report.md
            echo "‚ùå „Ç®„É©„Éº„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ‰øÆÊ≠£„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ" >> report.md
          else
            echo "" >> report.md
            echo "‚úÖ ÂΩ¢Âºè„ÅØÊ≠£Â∏∏„Åß„Åô„ÄÇGemini„ÅÆ„É¨„Éì„É•„ÉºÂÆå‰∫ÜÂæå„ÄÅÂïèÈ°å„Å™„Åë„Çå„Å∞ \`/publish\` „ÅßÂÖ¨Èñã„Åß„Åç„Åæ„Åô„ÄÇ" >> report.md
          fi

          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment Result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ---------------------------------------------------
  # Job 2: ÂÖ¨Èñã„Éª„Éû„Éº„Ç∏Âá¶ÁêÜ (/publish „Ç≥„Éû„É≥„Éâ„ÅßÂÆüË°å)
  # ---------------------------------------------------
  publish-article:
    name: Publish Article
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/publish')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Info
        id: pr
        run: echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      # 1. „Ç≥„É°„É≥„ÉàÊäïÁ®øËÄÖ„ÅåPR‰ΩúÊàêËÄÖÊú¨‰∫∫„ÅãÁ¢∫Ë™ç
      - name: Check Author
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });
            if (pr.data.user.login !== context.payload.comment.user.login) {
              core.setFailed('‚õîÔ∏è /publish „Ç≥„Éû„É≥„Éâ„ÅØPR‰ΩúÊàêËÄÖ„ÅÆ„Åø„ÅåÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
            }

      # 2. Gemini„ÅÆ„Çπ„Éë„É†Âà§ÂÆö„ÇíÁ¢∫Ë™çÔºàIssue„Ç≥„É°„É≥„Éà„Å®PR„É¨„Éì„É•„Éº‰∏°Êñπ„ÇíÊ§úÁ¥¢Ôºâ
      - name: Check Gemini Verdict
        id: gemini-check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1. ÈÄöÂ∏∏„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂèñÂæó
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber
            });

            // 2. „É¨„Éì„É•„Éº„Ç≥„É°„É≥„ÉàÔºàPR ReviewÔºâ„ÇíÂèñÂæó
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber
            });

            // 3. ‰∏°Êñπ„ÇíÁµ±Âêà„Åó„Å¶ÊôÇÁ≥ªÂàóÈ†Ü„Å´‰∏¶„ÅπÊõø„Åà
            // „Ç≥„É°„É≥„Éà„Å´„ÅØ created_at, „É¨„Éì„É•„Éº„Å´„ÅØ submitted_at „Åå„ÅÇ„Çã„Åü„ÇÅÁµ±‰∏Ä„Åó„Å¶Êâ±„ÅÜ
            const allFeedback = [
              ...comments.data.map(c => ({
                body: c.body,
                user: c.user.login,
                date: new Date(c.created_at)
              })),
              ...reviews.data.map(r => ({
                body: r.body,
                user: r.user.login,
                date: new Date(r.submitted_at)
              }))
            ].sort((a, b) => a.date - b.date); // Âè§„ÅÑÈ†Ü -> Êñ∞„Åó„ÅÑÈ†Ü

            // 4. Gemini (gemini-code-assist„ÇíÂê´„ÇÄ„É¶„Éº„Ç∂„Éº) „ÅÆ„Ç≥„É°„É≥„Éà„ÇíÊ§úÁ¥¢
            const botComments = allFeedback.filter(c =>
              c.user.includes('gemini') && c.body.includes('[SPAM-CHECK:')
            );

            if (botComments.length === 0) {
              core.setFailed('‚õîÔ∏è Gemini„Å´„Çà„Çã„É¨„Éì„É•„ÉºÔºà„Çπ„Éë„É†Âà§ÂÆöÔºâ„Åå„Åæ„Å†Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
              return;
            }

            // ÊúÄÊñ∞„ÅÆÂà§ÂÆö„ÇíÊé°Áî®
            const lastComment = botComments[botComments.length - 1];
            console.log(`Found Gemini verdict from: ${lastComment.date.toISOString()}`);

            if (lastComment.body.includes('[SPAM-CHECK: FAIL]')) {
              core.setFailed('‚õîÔ∏è Gemini„Å´„Çà„Çä„Çπ„Éë„É†„Åæ„Åü„ÅØ‰∏çÈÅ©Âàá„Å®Âà§ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Éû„Éº„Ç∏„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
            } else if (lastComment.body.includes('[SPAM-CHECK: PASS]')) {
              console.log('Gemini check passed.');
            } else {
              core.setFailed('‚õîÔ∏è Gemini„ÅÆÂà§ÂÆö„Çø„Ç∞„ÅåË™≠„ÅøÂèñ„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }

      # 3. ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØÔºàÂøµ„ÅÆ„Åü„ÇÅÂÜçÂÆüË°åÔºâ
      - name: Final Format Check
        run: |
          # ÂøÖË¶Å„Å™„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
          # „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà„Åó„Å¶main„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÇíÂæ©ÂÖÉ
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-branch
          git checkout pr-branch
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py
          pip install pyyaml

          # „ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
          git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD > changed_files.txt
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              if [ -f "$file" ]; then
                python scripts/check_pr.py "$file" > result.json
                if [ "$(jq -r '.is_valid_format' result.json)" != "true" ]; then
                  echo "Format Error in $file"
                  exit 1
                fi
              fi
            fi
          done < changed_files.txt

      # 3.5. Ë®ò‰∫ã„ÅÆdateËá™ÂãïÊõ¥Êñ∞
      - name: Update Article Dates
        run: |
          # PRÂÜÖ„ÅßÂ§âÊõ¥„Åï„Çå„ÅüË®ò‰∫ã„Éï„Ç°„Ç§„É´„ÇíÊ§úÂá∫
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-branch
          git checkout pr-branch
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/update_article_dates.py
          pip install pyyaml

          # Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
          git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD > changed_files.txt

          # _posts/*.md „Éï„Ç°„Ç§„É´„Çí „Éï„Ç£„É´„Çø„Åó„Å¶ update_article_dates.py „Å´Ê∏°„Åô
          article_files=()
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              if [ -f "$file" ]; then
                article_files+=("$file")
              fi
            fi
          done < changed_files.txt

          # „Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞
          if [ ${#article_files[@]} -gt 0 ]; then
            python scripts/update_article_dates.py "${article_files[@]}"

            # git Ë®≠ÂÆöÔºàbotÂêçÁæ©„Åß„ÅÆ„Ç≥„Éü„ÉÉ„ÉàÔºâ
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            # Â§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞
            git add "${article_files[@]}"

            # „Ç≥„Éü„ÉÉ„Éà
            git commit -m "ü§ñ Ë®ò‰∫ã„ÅÆdate/lastupdate„ÇíËá™ÂãïÊõ¥Êñ∞\nÊäïÁ®øÊó•ÊôÇ„ÇíÁèæÂú®ÊôÇÂàª„Å´Ëá™ÂãïË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ"

            # ÁèæÂú®„ÅÆ„Éñ„É©„É≥„ÉÅ„ÇíÊõ¥Êñ∞
            git push origin pr-branch:refs/heads/${{ github.head_ref }}
          fi

      # 4. Approve & Merge: ÂÖà„Å´Approve„ÇíË°å„ÅÑ„ÄÅ„Åù„ÅÆÂæå„Éû„Éº„Ç∏„ÇíË©¶Ë°å„Åó„Åæ„Åô
      - name: Approve and Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1) Approve („É¨„Éì„É•„Éº„Å®„Åó„Å¶ÊâøË™ç)
            try {
              await github.rest.pulls.createReview({
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: 'ü§ñ Ëá™ÂãïÊ§úË®º„ÇíÈÄöÈÅé„Åó„Åü„Åü„ÇÅÊâøË™ç„Åó„Åæ„Åô„ÄÇ'
              });
              console.log('‚úÖ PR approved');
            } catch (error) {
              console.log('‚ö†Ô∏è Approval failed: ' + error.message);
              // ÊâøË™ç„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„ÄÅ„Åæ„Åü„ÅØÊ®©Èôê‰∏çË∂≥„Å™„Å©„ÅßÂ§±Êïó„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çã„Åå„ÄÅÁ∂öË°å
            }

            // 2) Merge
            try {
              await github.rest.pulls.merge({
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });

              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: prNumber,
                body: 'üéâ Ë®ò‰∫ã„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„ÅüÔºÅ'
              });
            } catch (error) {
              // „Éû„Éº„Ç∏„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØApprove„ÅØÊÆã„Çã„Åü„ÇÅ„ÄÅÊòéÁ§∫ÁöÑ„Å´Â§±Êïó„Å®„Åó„Å¶ÈÄöÁü•
              core.setFailed('‚ùå „Éû„Éº„Ç∏„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâøË™ç„ÅØÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊâãÂãï„Åß„Éû„Éº„Ç∏„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Ç®„É©„Éº: ' + error.message);
            }
