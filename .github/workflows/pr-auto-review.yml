name: PR Auto Review and Merge

on:
  # å¤‰æ›´ç‚¹1: pull_request ã§ã¯ãªã pull_request_target ã‚’ä½¿ç”¨
  # ã“ã‚Œã«ã‚ˆã‚Š Fork ã‹ã‚‰ã® PR ã§ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™ãŒä»˜ä¸Žã•ã‚Œã¾ã™
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**/*.md'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ---------------------------------------------------
  # Job 1: å½¢å¼ãƒã‚§ãƒƒã‚¯ & çµæžœã‚³ãƒ¡ãƒ³ãƒˆ (PRä½œæˆãƒ»æ›´æ–°æ™‚ã«å®Ÿè¡Œ)
  # ---------------------------------------------------
  validate-format:
    name: Validate Format
    runs-on: ubuntu-latest
    # pull_request_target ãªã®ã§ã€event_name ã§ã®åˆ†å²æ¡ä»¶ã‚’ä¿®æ­£
    if: github.event_name == 'pull_request_target'

    steps:
      # é‡è¦: pull_request_target ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œè¦ªã®mainã€ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚
      # æŠ•ç¨¿ã•ã‚ŒãŸè¨˜äº‹ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€PRã®ã‚³ãƒŸãƒƒãƒˆã‚’æ˜Žç¤ºçš„ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }} # PRã®å…ˆç«¯ã‚’å–å¾—
          fetch-depth: 0

      # é‡è¦: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ”¹ã–ã‚“ã‚’é˜²ããŸã‚ã€æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã ã‘ã¯
      # å¿…ãšã€Œè¦ªãƒªãƒã‚¸ãƒˆãƒªã®mainã€ã‹ã‚‰å¾©å…ƒã—ã¦ä¸Šæ›¸ãã—ã¾ã™ã€‚
      - name: Restore trusted scripts
        run: |
          git fetch origin ${{ github.event.repository.default_branch }}
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_author_permission.py

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check Format and Permissions
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          # å·®åˆ†å–å¾—ã®æ¯”è¼ƒå…ƒã‚’èª¿æ•´
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          echo "## ðŸ“ å½¢å¼ãƒã‚§ãƒƒã‚¯çµæžœ" > report.md
          echo "" >> report.md

          has_error=false
          has_files=false
          has_permission_error=false

          while IFS= read -r file; do
            # --- ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯è¿½åŠ  ---
            # 1) ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ: `_posts/` é…ä¸‹ã® .md ä»¥å¤–ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã‚¨ãƒ©ãƒ¼
            if [[ "$file" != _posts/*.md ]]; then
              echo "- âŒ **$file**: ã‚·ã‚¹ãƒ†ãƒ ä¿è­·ã®ãŸã‚ã€\`_posts/\` ä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’å«ã‚€PRã¯è‡ªå‹•æ‰¿èªã§ãã¾ã›ã‚“ã€‚" >> report.md
              has_error=true
              continue
            fi

            # 2) ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ç¦æ­¢
            if [[ "$file" == "_posts/template.md" ]]; then
              echo "- âŒ **$file**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚" >> report.md
              has_error=true
              continue
            fi
            # ------------------------------------

            has_files=true
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆå‰Šé™¤ã•ã‚ŒãŸå ´åˆãªã©ã®ã‚¨ãƒ©ãƒ¼å›žé¿ï¼‰
            if [ -f "$file" ]; then
              # --- ðŸ” ç·¨é›†æ¨©é™ãƒã‚§ãƒƒã‚¯ ---
              python scripts/check_author_permission.py "$file" "$PR_AUTHOR" --base-branch "$BASE_BRANCH" > permission.json || true
              
              is_permitted=$(jq -r '.is_permitted' permission.json)
              is_new_file=$(jq -r '.is_new_file' permission.json)
              permission_reason=$(jq -r '.reason' permission.json)
              file_authors=$(jq -r '.file_authors | join(", ")' permission.json)
              
              if [ "$is_permitted" != "true" ]; then
                echo "- â›” **$file**: ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“" >> report.md
                echo "  - ç†ç”±: $permission_reason" >> report.md
                if [ -n "$file_authors" ] && [ "$file_authors" != "null" ]; then
                  echo "  - ç·¨é›†å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼: $file_authors" >> report.md
                fi
                has_error=true
                has_permission_error=true
                continue
              fi
              # --- æ¨©é™ãƒã‚§ãƒƒã‚¯å®Œäº† ---

              # å½¢å¼ãƒã‚§ãƒƒã‚¯
              python scripts/check_pr.py "$file" > result.json

              valid=$(jq -r '.is_valid_format' result.json)
              errors=$(jq -r '.issues | join(", ")' result.json)

              if [ "$valid" == "true" ]; then
                if [ "$is_new_file" == "true" ]; then
                  echo "- âœ… **$file**: æ–°è¦ä½œæˆ - å½¢å¼OK" >> report.md
                else
                  echo "- âœ… **$file**: ç·¨é›†ï¼ˆæ¨©é™ç¢ºèªæ¸ˆã¿ï¼‰ - å½¢å¼OK" >> report.md
                fi
              else
                echo "- âŒ **$file**: å½¢å¼ã‚¨ãƒ©ãƒ¼" >> report.md
                echo "  - ç†ç”±: $errors" >> report.md
                has_error=true
              fi
            fi
          done < changed_files.txt

          if [ "$has_files" = "false" ]; then
            echo "æ¤œè¨¼å¯¾è±¡ã®è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> report.md
          elif [ "$has_permission_error" == "true" ]; then
            echo "" >> report.md
            echo "â›” **ç·¨é›†æ¨©é™ã‚¨ãƒ©ãƒ¼**: ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸè¨˜äº‹ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚" >> report.md
            echo "" >> report.md
            echo "> ðŸ’¡ è¨˜äº‹ã®ç·¨é›†ã¯ã€ãã®è¨˜äº‹ã‚’ä½œæˆã—ãŸæœ¬äººï¼ˆéŽåŽ»ã«ã‚³ãƒŸãƒƒãƒˆã—ãŸã“ã¨ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®ã¿å¯èƒ½ã§ã™ã€‚" >> report.md
          elif [ "$has_error" == "true" ]; then
            echo "" >> report.md
            echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ãŸã‚ã€ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚" >> report.md
          else
            echo "" >> report.md
            echo "âœ… å½¢å¼ã¯æ­£å¸¸ã§ã™ã€‚Geminiã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€å•é¡Œãªã‘ã‚Œã° \`/publish\` ã§å…¬é–‹ã§ãã¾ã™ã€‚" >> report.md
          fi

          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment Result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ---------------------------------------------------
  # Job 2: å…¬é–‹ãƒ»ãƒžãƒ¼ã‚¸å‡¦ç† (/publish ã‚³ãƒžãƒ³ãƒ‰ã§å®Ÿè¡Œ)
  # ---------------------------------------------------
  publish-article:
    name: Publish Article
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/publish')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Info
        id: pr
        run: echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      # 1. ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…ãŒPRä½œæˆè€…æœ¬äººã‹ç¢ºèª
      - name: Check Author
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });
            if (pr.data.user.login !== context.payload.comment.user.login) {
              core.setFailed('â›”ï¸ /publish ã‚³ãƒžãƒ³ãƒ‰ã¯PRä½œæˆè€…ã®ã¿ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚');
            }

      # 2. Geminiã®ã‚¹ãƒ‘ãƒ åˆ¤å®šã‚’ç¢ºèªï¼ˆIssueã‚³ãƒ¡ãƒ³ãƒˆã¨PRãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸¡æ–¹ã‚’æ¤œç´¢ï¼‰
      - name: Check Gemini Verdict
        id: gemini-check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1. é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber
            });

            // 2. ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPR Reviewï¼‰ã‚’å–å¾—
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber
            });

            // 3. ä¸¡æ–¹ã‚’çµ±åˆã—ã¦æ™‚ç³»åˆ—é †ã«ä¸¦ã¹æ›¿ãˆ
            // ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ created_at, ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¯ submitted_at ãŒã‚ã‚‹ãŸã‚çµ±ä¸€ã—ã¦æ‰±ã†
            const allFeedback = [
              ...comments.data.map(c => ({
                body: c.body,
                user: c.user.login,
                date: new Date(c.created_at)
              })),
              ...reviews.data.map(r => ({
                body: r.body,
                user: r.user.login,
                date: new Date(r.submitted_at)
              }))
            ].sort((a, b) => a.date - b.date); // å¤ã„é † -> æ–°ã—ã„é †

            // 4. Gemini (gemini-code-assistã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼) ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const botComments = allFeedback.filter(c =>
              c.user.includes('gemini') && c.body.includes('[SPAM-CHECK:')
            );

            if (botComments.length === 0) {
              core.setFailed('â›”ï¸ Geminiã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ‘ãƒ åˆ¤å®šï¼‰ãŒã¾ã è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            // æœ€æ–°ã®åˆ¤å®šã‚’æŽ¡ç”¨
            const lastComment = botComments[botComments.length - 1];
            console.log(`Found Gemini verdict from: ${lastComment.date.toISOString()}`);

            if (lastComment.body.includes('[SPAM-CHECK: FAIL]')) {
              core.setFailed('â›”ï¸ Geminiã«ã‚ˆã‚Šã‚¹ãƒ‘ãƒ ã¾ãŸã¯ä¸é©åˆ‡ã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒžãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚');
            } else if (lastComment.body.includes('[SPAM-CHECK: PASS]')) {
              console.log('Gemini check passed.');
            } else {
              core.setFailed('â›”ï¸ Geminiã®åˆ¤å®šã‚¿ã‚°ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
            }

      # 3. å½¢å¼ãƒã‚§ãƒƒã‚¯ & æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚å†å®Ÿè¡Œï¼‰
      - name: Final Format and Permission Check
        id: final-check
        run: |
          # å¿…è¦ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦mainã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å¾©å…ƒ
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-branch
          git checkout pr-branch
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_pr.py
          git checkout origin/${{ github.event.repository.default_branch }} -- scripts/check_author_permission.py
          pip install pyyaml

          # PRä½œæˆè€…ã‚’å–å¾—
          PR_AUTHOR=$(gh pr view ${{ steps.pr.outputs.number }} --json author -q '.author.login')
          echo "PR Author: $PR_AUTHOR"

          # ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD > changed_files.txt
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              if [ -f "$file" ]; then
                # æ¨©é™ãƒã‚§ãƒƒã‚¯
                python scripts/check_author_permission.py "$file" "$PR_AUTHOR" --base-branch "${{ github.event.repository.default_branch }}" > permission.json || true
                if [ "$(jq -r '.is_permitted' permission.json)" != "true" ]; then
                  echo "Permission denied for $file"
                  echo "Reason: $(jq -r '.reason' permission.json)"
                  exit 1
                fi

                # å½¢å¼ãƒã‚§ãƒƒã‚¯
                python scripts/check_pr.py "$file" > result.json
                if [ "$(jq -r '.is_valid_format' result.json)" != "true" ]; then
                  echo "Format Error in $file"
                  exit 1
                fi
              fi
            fi
          done < changed_files.txt
        env:
          GH_TOKEN: ${{ github.token }}

      # 4. Approve & Merge: å…ˆã«Approveã‚’è¡Œã„ã€ãã®å¾Œãƒžãƒ¼ã‚¸ã‚’è©¦è¡Œã—ã¾ã™
      - name: Approve and Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1) Approve (ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦æ‰¿èª)
            try {
              await github.rest.pulls.createReview({
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: 'ðŸ¤– è‡ªå‹•æ¤œè¨¼ã‚’é€šéŽã—ãŸãŸã‚æ‰¿èªã—ã¾ã™ã€‚'
              });
              console.log('âœ… PR approved');
            } catch (error) {
              console.log('âš ï¸ Approval failed: ' + error.message);
              // æ‰¿èªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã€ã¾ãŸã¯æ¨©é™ä¸è¶³ãªã©ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŒã€ç¶šè¡Œ
            }

            // 2) Merge
            try {
              await github.rest.pulls.merge({
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });

              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: prNumber,
                body: 'ðŸŽ‰ è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼'
              });
            } catch (error) {
              // ãƒžãƒ¼ã‚¸ã«å¤±æ•—ã—ãŸå ´åˆã¯Approveã¯æ®‹ã‚‹ãŸã‚ã€æ˜Žç¤ºçš„ã«å¤±æ•—ã¨ã—ã¦é€šçŸ¥
              core.setFailed('âŒ ãƒžãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰¿èªã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚æ‰‹å‹•ã§ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ' + error.message);
            }