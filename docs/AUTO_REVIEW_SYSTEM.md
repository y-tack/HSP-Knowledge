# HSP-Knowledge 記事投稿の自動検証・承認システム

このシステムは、記事投稿PRの品質を自動的に検証し、適切な記事を自動承認・マージする機能を提供します。

## 🎯 機能概要

### 1. 自動検証（PR作成時）

記事投稿のPRが作成されると、自動的に以下の検証が実行されます：

#### スパム判定
- HSP関連の内容かどうか
- 広告や不適切なコンテンツでないか
- 意味のない文字列や乱文でないか
- 外部リンクの過度な使用がないか

#### 形式検証
- Front Matter（YAML）の必須フィールド確認
  - `title`, `date`, `author`, `tags`, `summary`
- テンプレートのままでないか
  - author が「あなたの名前」のままでないか
  - title に「記事タイトル」などが残っていないか
- ファイル名の形式チェック
  - `YYYY-MM-DD-title.md` 形式か
  - `template.md` や `-new-article.md` でないか
- 本文の存在確認

#### 更新時の追加検証
- 投稿者名（author）が変更されていないか
- ファイル名が適切か

#### 🔐 編集権限チェック（重要）
- **新規作成**: 誰でも作成可能
- **既存記事の編集**: その記事に過去にコミットしたことがあるユーザーのみ許可

> ⚠️ これにより、他人の記事を勝手に書き換えるイタズラを防止しています。

### 2. 自動承認・マージ（/publish コマンド）

検証に合格した記事は、投稿者が **`/publish`** とコメントすることで自動的に承認・マージされます。

## 📝 使い方

### 記事を投稿する

1. `_posts/` フォルダに記事を作成
2. ブランチを作成してPRを開く
3. 自動検証が実行され、結果がコメントされます

### 自動マージする

検証に合格した記事（✅ **承認可能** と表示された場合）：

1. PRのコメント欄に `/publish` と入力
2. 自動的に承認され、マージされます

**注意**: `/publish` コマンドはPRの作成者のみが使用できます。

## 🔍 検証結果の見方

PRに自動的に投稿されるコメントの意味：

| アイコン | 意味 | 対応 |
|---------|------|------|
| ✅ **承認可能** | 記事は適切です | `/publish` でマージ可能 |
| ✅ **承認可能（改善提案あり）** | 軽微な改善提案あり | `/publish` でマージ可能（提案は任意） |
| ⚠️ **形式エラー** | 形式に問題あり | 記事を修正してください |
| ❌ **スパム判定** | スパムと判定 | 記事内容を見直してください |

## 🛠️ システム構成

### ファイル構成

```
.gemini/
  config.yaml                  # Gemini Code Assist基本設定
  styleguide.md                # コードレビューのスタイルガイド
.github/
  workflows/
    pr-auto-review.yml         # 自動検証・承認のワークフロー
scripts/
  check_pr.py                  # 形式検証スクリプト
  check_author_permission.py   # 編集権限チェックスクリプト
```

### .gemini/config.yaml

Gemini Code Assistの基本設定ファイルです。コードレビューの有効化、重要度閾値、無視するファイルパターンなどを設定します。

### .gemini/styleguide.md

Gemini Code Assistがコードレビューを実行する際に従うスタイルガイドです。
記事のレビュー方針、重要度の判定基準、コメントの書き方などを定義しています。

**重要**: 軽微な改善提案（MEDIUM、LOW）があっても自動マージは可能です。

### scripts/check_pr.py

記事の検証ロジックを実装したPythonスクリプトです。以下を検証します：

- ファイル名の形式
- Front Matterの必須フィールド
- テンプレートのまま残っている箇所
- 投稿者名の不変性（更新時）
- スパム判定

### .github/workflows/pr-auto-review.yml

GitHub Actionsワークフローで、以下の処理を自動化します：

1. **PR作成時**: 記事の自動検証と結果のコメント投稿
2. **/publish コマンド**: 自動承認・マージ

## 🔐 セキュリティ

### 編集権限システム

イタズラによる記事の書き換えを防止するため、**既存記事の編集には権限が必要**です。

| 操作 | 権限 |
|------|------|
| 新規記事の作成 | 誰でも可能 |
| 既存記事の編集 | その記事に過去にコミットしたユーザーのみ |
| 既存記事の削除 | その記事に過去にコミットしたユーザーのみ |

**仕組み**:
- PRが作成されると、変更対象ファイルごとにGitのコミット履歴を確認
- PR作成者がそのファイルの過去のコミット者に含まれていれば編集を許可
- 含まれていなければ、編集権限エラーとなりマージ不可

### その他のセキュリティ

- `/publish` コマンドは**PRの作成者のみ**が使用可能
- 検証に合格した記事のみが自動マージされます
- スパム判定により不適切な内容は自動的に却下されます
- `_posts/` 以外のファイル変更を含むPRは自動承認されません
- 検証スクリプトは常にmainブランチから取得（改ざん防止）

## 🚀 セットアップ

このシステムはすでに設定済みです。追加の設定は不要です。

### 必要な権限

GitHub Actionsに以下の権限が必要です（既に設定済み）：

- `contents: write` - マージ操作
- `pull-requests: write` - PR承認とコメント
- `issues: write` - コメント投稿

## 📚 例

### 良い例（自動承認される）

```markdown
---
layout: post
title: HSPでファイル読み込み入門
date: 2025-12-07 15:00:00 +0900
author: Taro Yamada
tags: [HSP3, ファイル操作, 初心者向け]
summary: HSP3でテキストファイルを読み込む方法を解説します
---

HSPでファイルを読み込む方法を紹介します。

## noteload命令を使う

`noteload` 命令を使うと簡単にファイルを読み込めます。

\`\`\`hsp
notesel buf
noteload "data.txt"
mes buf
\`\`\`
```

**注**: Gemini Code Assistから軽微な改善提案（リンクの書き方、書式の改善等）があっても、
スパムでなく基本形式が正しければ自動マージ可能です。

### 却下される例

#### ファイル名がテンプレートのまま
- ❌ `2025-12-07-new-article.md`
- ✅ `2025-12-07-hsp-file-io.md`

#### Front Matterが不完全
```markdown
---
layout: post
title: 記事タイトル（ここを変更）  # ← テンプレートのまま
author: あなたの名前             # ← テンプレートのまま
---
```

#### HSPと無関係な内容
スパム判定により自動的に却下されます。

## 🤝 貢献

記事の投稿は自由ですが、以下のガイドラインを守ってください：

- HSPに関連する内容
- テンプレートから適切に変更
- 正しいファイル名形式
- 適切なFront Matter

## ❓ FAQ

### Q: Gemini Code Assistから改善提案があったけどマージできる？

A: はい！軽微な改善提案（MEDIUM、LOW重要度）があっても `/publish` でマージ可能です。
提案を反映するかどうかは投稿者の判断で決められます。

### Q: 検証に失敗した場合は？

A: スパム判定や形式エラーの場合は、コメントに表示された問題点を修正し、PRを更新してください。
再度自動検証が実行されます。

### Q: /publish が使えない

A: PRの作成者のみが使用できます。他の人がマージする場合は、手動でレビュー・承認してください。

### Q: 他の人の記事を編集したい

A: 既存記事の編集は、その記事に過去にコミットしたユーザーのみ可能です。
記事の訂正やアップデートを依頼したい場合は、Issueを作成して記事の作成者に連絡してください。

### Q: 「編集権限がありません」と表示された

A: その記事はあなたが作成したものではないため、編集できません。
記事に修正が必要な場合は、Issueを作成してください。

### Q: 検証をスキップしたい

A: 自動検証はスキップできませんが、手動でレビュー・マージすることは可能です。

## 📞 サポート

問題が発生した場合は、Issueを作成してください。
